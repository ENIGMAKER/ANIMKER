<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üéå ANIMKER</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Ocultar scrollbars pero mantener funcionalidad */
        ::-webkit-scrollbar {
            width: 0px;
            background: transparent;
        }
        
        * {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #2d3748;
            line-height: 1.6;
            overflow-x: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .header-stats {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        .login-section {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .login-card {
            background: white;
            padding: 40px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
        }

        .login-card h2 {
            margin-bottom: 20px;
            color: #2d3748;
        }

        .login-card p {
            margin-bottom: 30px;
            color: #718096;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .toolbar {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: space-between;
        }

        .toolbar-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sync-status {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: #718096;
        }

        .sync-status.syncing {
            color: #667eea;
        }

        .sync-status.offline {
            color: #ff6b6b;
        }

        .quick-add {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .quick-add h3 {
            margin-bottom: 15px;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
        }

        /* Add conditional grid for movie/series */
        .form-row.movie-mode {
            grid-template-columns: 2fr 1fr 1fr auto;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 5px;
        }

        input, select, textarea {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s ease;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-google {
            background: #4285f4;
            color: white;
        }

        .star-rating {
            display: flex;
            gap: 2px;
        }

        .star {
            font-size: 20px;
            color: #e2e8f0;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .star.active {
            color: #ffd700;
        }

        .star:hover {
            color: #ffed4e;
        }

        .opening-stars {
            display: flex;
            gap: 2px;
            margin-top: 8px;
            flex-wrap: wrap;
        }

        .opening-star {
            font-size: 16px;
            color: #e2e8f0;
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .opening-star.active {
            color: #ff6b9d;
        }

        .opening-star:hover {
            color: #ff8fab;
        }

        /* Add styles for add season button */
        .add-season-btn {
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            color: #718096;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .add-season-btn:hover {
            border-color: #ff6b9d;
            color: #ff6b9d;
        }

        /* Add styles for type badge */
        .type-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .type-badge.serie {
            background: #e6f3ff;
            color: #0066cc;
        }

        .type-badge.movie {
            background: #fff0e6;
            color: #cc6600;
        }

        .view-toggle {
            display: flex;
            background: #f7fafc;
            border-radius: 8px;
            padding: 4px;
        }

        .view-btn {
            background: none;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
        }

        .view-btn.active {
            background: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .search-filter {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .search-input {
            width: 250px;
        }

        .category-filter {
            width: 150px;
        }

        .content-area {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .category-tabs {
            display: flex;
            background: #f7fafc;
            border-bottom: 1px solid #e2e8f0;
            overflow-x: auto;
        }

        .category-tab {
            background: none;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            font-weight: 600;
            color: #718096;
            transition: all 0.2s ease;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
        }

        .category-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }

        .category-tab:hover {
            color: #4a5568;
        }

        .anime-content {
            padding: 20px;
        }

        .anime-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .anime-card {
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
            background: white;
            position: relative;
        }

        .anime-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }

        .anime-card:hover .category-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .category-tooltip {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 12px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .anime-image {
            width: 100%;
            height: 160px;
            object-fit: cover;
            background: #f7fafc;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a0aec0;
            font-size: 14px;
        }

        .anime-info {
            padding: 15px;
        }

        .anime-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 8px;
            color: #2d3748;
        }

        .anime-progress {
            font-size: 14px;
            color: #718096;
            margin-bottom: 8px;
        }

        .anime-rating {
            margin-bottom: 8px;
        }

        .anime-opening {
            margin-bottom: 12px;
        }

        .opening-label {
            font-size: 12px;
            color: #718096;
            margin-bottom: 4px;
        }

        .anime-actions {
            display: flex;
            gap: 8px;
        }

        .anime-list {
            display: none;
        }

        .anime-list.active {
            display: block;
        }

        .anime-list-item {
            display: grid;
            grid-template-columns: 60px 2fr 1fr 1fr 120px 100px;
            gap: 15px;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.2s ease;
            position: relative;
        }

        .anime-list-item:hover {
            background: #f7fafc;
        }

        .anime-list-item:hover .category-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .anime-list-item:last-child {
            border-bottom: none;
        }

        .anime-thumb {
            width: 50px;
            height: 70px;
            object-fit: cover;
            border-radius: 6px;
            background: #f7fafc;
        }

        .anime-list-title {
            font-weight: 600;
            color: #2d3748;
        }

        .anime-list-progress {
            color: #718096;
            font-size: 14px;
        }

        .anime-list-rating {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .anime-list-actions {
            display: flex;
            gap: 5px;
        }

        .category-manager {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .category-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }

        .category-tag {
            background: #e2e8f0;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .category-tag .remove {
            background: #ff6b6b;
            color: white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: #718096;
        }

        .close:hover {
            color: #2d3748;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            width: 100%;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            opacity: 0;
            width: 100%;
            height: 100%;
            cursor: pointer;
        }

        .file-input-display {
            background: #f7fafc;
            border: 2px dashed #cbd5e0;
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            transition: border-color 0.3s ease;
        }

        .file-input-wrapper:hover .file-input-display {
            border-color: #667eea;
        }

        .image-preview {
            max-width: 100%;
            max-height: 200px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .empty-state h3 {
            margin-bottom: 10px;
            font-size: 20px;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #718096;
        }

        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid #e2e8f0;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design para M√≥viles */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header-stats {
                gap: 15px;
                font-size: 0.8rem;
            }

            .user-info {
                order: -1;
            }

            .container {
                padding: 10px;
            }

            .toolbar {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
                padding: 15px;
            }

            .toolbar-section {
                justify-content: center;
                flex-wrap: wrap;
            }

            .search-filter {
                flex-direction: column;
                width: 100%;
            }

            .search-input, .category-filter {
                width: 100%;
            }

            .view-toggle {
                justify-content: center;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            /* Movie mode also single column on mobile */
            .form-row.movie-mode {
                grid-template-columns: 1fr;
            }

            .quick-add {
                padding: 15px;
            }

            .category-manager {
                padding: 15px;
            }

            .anime-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
                gap: 15px;
            }

            .anime-card {
                margin: 0 5px;
            }

            .anime-content {
                padding: 15px;
            }

            .anime-list-item {
                grid-template-columns: 50px 1fr 80px;
                gap: 10px;
                padding: 10px;
            }

            .anime-list-item .anime-list-progress,
            .anime-list-item .anime-list-rating {
                display: none;
            }

            .category-tabs {
                padding: 0 10px;
            }

            .category-tab {
                padding: 12px 15px;
                font-size: 13px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
                margin: 10px;
            }

            .btn {
                padding: 12px 16px;
                font-size: 14px;
            }

            .btn-sm {
                padding: 8px 12px;
                font-size: 12px;
            }

            .anime-actions {
                flex-direction: column;
                gap: 5px;
            }

            .anime-actions .btn {
                width: 100%;
                justify-content: center;
            }

            .category-tooltip {
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0,0,0,0.9);
                padding: 8px 12px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
            }
        }

        @media (max-width: 480px) {
            .header h1 {
                font-size: 1.3rem;
            }

            .anime-grid {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .anime-card {
                margin: 0;
            }

            .container {
                padding: 5px;
            }

            .toolbar, .quick-add, .category-manager {
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Secci√≥n de Login -->
    <div class="login-section" id="loginSection">
        <div class="login-card">
            <h2>üéå ANIMKER</h2>
            <p>Inicia sesi√≥n para sincronizar tus animes entre dispositivos</p>
            <button class="btn btn-google" onclick="signInWithGoogle()">
                <span>üîê</span> Iniciar sesi√≥n con Google
            </button>
            <p style="margin-top: 20px; font-size: 12px; color: #a0aec0;">
                Tus datos se sincronizar√°n autom√°ticamente en todos tus dispositivos
            </p>
        </div>
    </div>

    <div class="header">
        <div class="header-content">
            <h1>üéå ANIMKER</h1>
            <div class="header-stats">
                <div class="stat-item">
                    <div class="stat-number" id="totalAnimes">0</div>
                    <div>Animes</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalCategories">0</div>
                    <div>Categor√≠as</div>
                </div>
            </div>
            <div class="user-info">
                <img id="userAvatar" class="user-avatar" src="/placeholder.svg" alt="Usuario">
                <span id="userName"></span>
                <button class="btn btn-sm btn-secondary" onclick="signOut()">Salir</button>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Barra de herramientas -->
        <div class="toolbar">
            <div class="toolbar-section">
                <div class="search-filter">
                    <input type="text" id="searchInput" class="search-input" placeholder="üîç Buscar animes...">
                    <select id="categoryFilter" class="category-filter">
                        <option value="">Todas las categor√≠as</option>
                    </select>
                </div>
            </div>
            
            <div class="toolbar-section">
                <div class="sync-status" id="syncStatus">
                    <span class="spinner" style="display: none;"></span>
                    <span id="syncText">üîÑ Sincronizado</span>
                </div>
                <div class="view-toggle">
                    <button class="view-btn active" onclick="switchView('grid')">üì± Tarjetas</button>
                    <button class="view-btn" onclick="switchView('list')">üìã Lista</button>
                </div>
                <button class="btn btn-sm" onclick="toggleCategoryManager()">‚öôÔ∏è Categor√≠as</button>
                <button class="btn btn-sm" onclick="toggleQuickAdd()">‚ûï A√±adir Anime</button>
            </div>
        </div>

        <!-- Gestor de categor√≠as -->
        <div class="category-manager" id="categoryManager" style="display: none;">
            <h3>üìÇ Gestionar Categor√≠as</h3>
            <div class="form-row" style="grid-template-columns: 1fr auto;">
                <input type="text" id="newCategory" placeholder="Nueva categor√≠a...">
                <button class="btn" onclick="addCategory()">A√±adir</button>
            </div>
            <div class="category-list" id="categoryList"></div>
        </div>

        <!-- Formulario r√°pido de a√±adir anime -->
        <div class="quick-add" id="quickAdd" style="display: none;">
            <h3>‚ûï A√±adir Nuevo Anime</h3>
            
            /* Add type selector */
            <div class="form-group" style="margin-bottom: 15px;">
                <label for="animeType">Tipo</label>
                <select id="animeType" onchange="toggleAnimeType()">
                    <option value="serie">üì∫ Serie</option>
                    <option value="movie">üé¨ Pel√≠cula</option>
                </select>
            </div>

            <div class="form-row" id="addFormRow">
                <div class="form-group">
                    <label for="animeName">Nombre del Anime</label>
                    <input type="text" id="animeName" placeholder="Nombre del anime">
                </div>
                
                <div class="form-group">
                    <label for="animeCategory">Categor√≠a</label>
                    <select id="animeCategory">
                        <option value="">Seleccionar...</option>
                    </select>
                </div>

                /* Make season/episode conditional */
                <div class="form-group" id="seasonGroup">
                    <label>Temporada</label>
                    <input type="number" id="animeSeason" placeholder="1" min="1" value="1">
                </div>

                <div class="form-group" id="episodeGroup">
                    <label>Episodio</label>
                    <input type="number" id="animeEpisode" placeholder="1" min="0" value="1">
                </div>

                <div class="form-group">
                    <label>Valoraci√≥n</label>
                    <div class="star-rating" id="newAnimeRating">
                        <span class="star" data-rating="1">‚òÖ</span>
                        <span class="star" data-rating="2">‚òÖ</span>
                        <span class="star" data-rating="3">‚òÖ</span>
                        <span class="star" data-rating="4">‚òÖ</span>
                        <span class="star" data-rating="5">‚òÖ</span>
                    </div>
                </div>

                <button class="btn" onclick="addAnime()" id="addAnimeBtn">A√±adir</button>
            </div>

            /* Make openings conditional for series only */
            <div class="form-group" style="margin-top: 15px;" id="openingsGroup">
                <label>Openings que me gustan (por temporada)</label>
                <div class="opening-stars" id="newAnimeOpenings">
                    <span class="opening-star" data-season="1" title="Temporada 1">‚òÖ</span>
                    <span class="opening-star" data-season="2" title="Temporada 2">‚òÖ</span>
                    <span class="opening-star" data-season="3" title="Temporada 3">‚òÖ</span>
                    <span class="opening-star" data-season="4" title="Temporada 4">‚òÖ</span>
                    <span class="opening-star" data-season="5" title="Temporada 5">‚òÖ</span>
                    <button class="add-season-btn" onclick="addSeasonStar('new')">+ Temporada</button>
                </div>
                <small style="color: #718096;">Haz clic en las estrellas para marcar los openings que te gustan</small>
            </div>

            <div class="form-group" style="margin-top: 15px;">
                <label for="animeImage">Imagen del Anime (Opcional)</label>
                <div class="file-input-wrapper">
                    <input type="file" id="animeImage" accept="image/*">
                    <div class="file-input-display">
                        <p>üì∑ Haz clic para seleccionar una imagen</p>
                    </div>
                </div>
                <img id="imagePreview" class="image-preview" style="display: none;">
            </div>
        </div>

        <!-- √Årea de contenido principal -->
        <div class="content-area">
            <div class="category-tabs" id="categoryTabs"></div>
            
            <div class="anime-content">
                <div class="loading" id="loadingIndicator">
                    <div class="spinner"></div>
                    Cargando animes...
                </div>
                
                <!-- Vista de tarjetas -->
                <div class="anime-grid" id="animeGrid" style="display: none;"></div>
                
                <!-- Vista de lista -->
                <div class="anime-list" id="animeList"></div>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Anime -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Editar Anime</h3>
                <span class="close" onclick="closeEditModal()">&times;</span>
            </div>
            
            /* Add type selector in edit modal */
            <div class="form-group">
                <label for="editAnimeType">Tipo</label>
                <select id="editAnimeType" onchange="toggleEditAnimeType()">
                    <option value="serie">üì∫ Serie</option>
                    <option value="movie">üé¨ Pel√≠cula</option>
                </select>
            </div>

            <div class="form-group">
                <label for="editAnimeName">Nombre del Anime</label>
                <input type="text" id="editAnimeName">
            </div>
            
            <div class="form-group">
                <label for="editAnimeCategory">Categor√≠a</label>
                <select id="editAnimeCategory"></select>
            </div>

            /* Make season/episode conditional in edit modal */
            <div class="form-row" style="grid-template-columns: 1fr 1fr;" id="editSeasonEpisodeGroup">
                <div class="form-group">
                    <label for="editAnimeSeason">Temporada</label>
                    <input type="number" id="editAnimeSeason" min="1">
                </div>

                <div class="form-group">
                    <label for="editAnimeEpisode">Episodio</label>
                    <input type="number" id="editAnimeEpisode" min="0">
                </div>
            </div>

            <div class="form-group">
                <label>Valoraci√≥n</label>
                <div class="star-rating" id="editAnimeRating">
                    <span class="star" data-rating="1">‚òÖ</span>
                    <span class="star" data-rating="2">‚òÖ</span>
                    <span class="star" data-rating="3">‚òÖ</span>
                    <span class="star" data-rating="4">‚òÖ</span>
                    <span class="star" data-rating="5">‚òÖ</span>
                </div>
            </div>

            /* Make openings conditional for series only in edit modal */
            <div class="form-group" id="editOpeningsGroup">
                <label>Openings que me gustan (por temporada)</label>
                <div class="opening-stars" id="editAnimeOpenings">
                    <span class="opening-star" data-season="1" title="Temporada 1">‚òÖ</span>
                    <span class="opening-star" data-season="2" title="Temporada 2">‚òÖ</span>
                    <span class="opening-star" data-season="3" title="Temporada 3">‚òÖ</span>
                    <span class="opening-star" data-season="4" title="Temporada 4">‚òÖ</span>
                    <span class="opening-star" data-season="5" title="Temporada 5">‚òÖ</span>
                    <button class="add-season-btn" onclick="addSeasonStar('edit')">+ Temporada</button>
                </div>
                <small style="color: #718096;">Haz clic en las estrellas para marcar los openings que te gustan</small>
            </div>

            <div class="form-group">
                <label for="editAnimeImage">Cambiar Imagen</label>
                <div class="file-input-wrapper">
                    <input type="file" id="editAnimeImage" accept="image/*">
                    <div class="file-input-display">
                        <p>üì∑ Haz clic para cambiar la imagen</p>
                    </div>
                </div>
                <img id="editImagePreview" class="image-preview" style="display: none;">
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn" onclick="saveAnimeEdit()" id="saveEditBtn">Guardar Cambios</button>
                <button class="btn btn-secondary" onclick="closeEditModal()">Cancelar</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Importar Firebase
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut as firebaseSignOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, deleteDoc, onSnapshot, enableNetwork, disableNetwork } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ‚ö†Ô∏è CONFIGURACI√ìN FIREBASE - REEMPLAZA CON TUS DATOS
        const firebaseConfig = {
            apiKey: "AIzaSyDcDE85PgFjFZZEqT258trf166ECX-FRgI",
            authDomain: "animker-13816.firebaseapp.com",
            projectId: "animker-13816",
            storageBucket: "animker-13816.firebasestorage.app",
            messagingSenderId: "1011665882273",
            appId: "1:1011665882273:web:9fca86c290d66aeb9874e0"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Variables globales
        let categories = [];
        let animes = [];
        let currentUser = null;
        let currentRating = 0;
        let editRating = 0;
        let currentEditId = null;
        let newAnimeImage = null;
        let editAnimeImage = null;
        let currentView = 'grid';
        let currentCategory = 'all';
        let searchTerm = '';
        let isOnline = navigator.onLine;
        let unsubscribeAnimes = null;
        let unsubscribeCategories = null;
        let currentOpenings = [];
        let editOpenings = [];
        let newSeasonCount = 5;
        let editSeasonCount = 5;

        // Hacer funciones globales
        window.signInWithGoogle = signInWithGoogle;
        window.signOut = signOut;
        window.addCategory = addCategory;
        window.removeCategory = removeCategory;
        window.addAnime = addAnime;
        window.editAnime = editAnime;
        window.saveAnimeEdit = saveAnimeEdit;
        window.deleteAnime = deleteAnime;
        window.closeEditModal = closeEditModal;
        window.toggleCategoryManager = toggleCategoryManager;
        window.toggleQuickAdd = toggleQuickAdd;
        window.switchView = switchView;
        window.selectCategory = selectCategory;
        /* Add new functions to window */
        window.toggleAnimeType = toggleAnimeType;
        window.toggleEditAnimeType = toggleEditAnimeType;
        window.addSeasonStar = addSeasonStar;

        // Detectar estado de conexi√≥n
        window.addEventListener('online', () => {
            isOnline = true;
            updateSyncStatus('üîÑ Sincronizando...', 'syncing');
            enableNetwork(db);
        });

        window.addEventListener('offline', () => {
            isOnline = false;
            updateSyncStatus('üì¥ Sin conexi√≥n', 'offline');
            disableNetwork(db);
        });

        // Autenticaci√≥n
        function signInWithGoogle() {
            console.log("[v0] Attempting Google sign in...");
            signInWithPopup(auth, provider)
                .then((result) => {
                    console.log("[v0] User authenticated successfully:", result.user.email);
                })
                .catch((error) => {
                    console.error("[v0] Authentication error:", error.code, error.message);
                    let errorMessage = 'Error al iniciar sesi√≥n. ';
                    
                    if (error.code === 'auth/popup-blocked') {
                        errorMessage += 'El popup fue bloqueado. Por favor, permite popups para este sitio.';
                    } else if (error.code === 'auth/popup-closed-by-user') {
                        errorMessage += 'Cerraste el popup antes de completar el inicio de sesi√≥n.';
                    } else if (error.code === 'auth/unauthorized-domain') {
                        errorMessage += 'Este dominio no est√° autorizado. A√±√°delo en Firebase Console ‚Üí Authentication ‚Üí Settings ‚Üí Authorized domains.';
                    } else {
                        errorMessage += 'Por favor, int√©ntalo de nuevo. Error: ' + error.code;
                    }
                    
                    alert(errorMessage);
                });
        }

        function signOut() {
            firebaseSignOut(auth).then(() => {
                console.log('Usuario desconectado');
            }).catch((error) => {
                console.error('Error al cerrar sesi√≥n:', error);
            });
        }

        // Observar cambios de autenticaci√≥n
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loginSection').style.display = 'none';
                document.getElementById('userName').textContent = user.displayName;
                document.getElementById('userAvatar').src = user.photoURL;
                setupEventListeners();
                loadUserData();
                toggleAnimeType(); // Initialize view for add form
                toggleEditAnimeType(); // Initialize view for edit modal
            } else {
                currentUser = null;
                document.getElementById('loginSection').style.display = 'flex';
                if (unsubscribeAnimes) unsubscribeAnimes();
                if (unsubscribeCategories) unsubscribeCategories();
            }
        });

        // Cargar datos del usuario
        async function loadUserData() {
            if (!currentUser) return;

            updateSyncStatus('üîÑ Cargando...', 'syncing');

            try {
                // Cargar categor√≠as
                const categoriesRef = collection(db, 'users', currentUser.uid, 'categories');
                unsubscribeCategories = onSnapshot(categoriesRef, (snapshot) => {
                    categories = [];
                    snapshot.forEach((doc) => {
                        categories.push(doc.data().name);
                    });
                    
                    updateCategorySelects();
                    renderCategories();
                    renderCategoryTabs();
                    updateStats();
                });

                // Cargar animes
                const animesRef = collection(db, 'users', currentUser.uid, 'animes');
                unsubscribeAnimes = onSnapshot(animesRef, (snapshot) => {
                    animes = [];
                    snapshot.forEach((doc) => {
                        animes.push({ id: doc.id, ...doc.data() });
                    });
                    
                    renderCategoryTabs();
                    renderAnimes();
                    updateStats();
                    updateSyncStatus('‚úÖ Sincronizado', '');
                    
                    // Ocultar loading y mostrar vista correcta
                    document.getElementById('loadingIndicator').style.display = 'none';
                    if (currentView === 'grid') {
                        document.getElementById('animeGrid').style.display = 'grid';
                        document.getElementById('animeList').classList.remove('active');
                    } else {
                        document.getElementById('animeGrid').style.display = 'none';
                        document.getElementById('animeList').classList.add('active');
                    }
                });

            } catch (error) {
                console.error('Error cargando datos:', error);
                updateSyncStatus('‚ùå Error de sincronizaci√≥n', 'offline');
            }
        }

        // Guardar categor√≠as en Firebase
        async function saveCategoriesToFirebase() {
            if (!currentUser) return;

            try {
                updateSyncStatus('üîÑ Guardando categor√≠as...', 'syncing');
                
                const categoriesRef = collection(db, 'users', currentUser.uid, 'categories');
                
                // Obtener categor√≠as existentes
                const snapshot = await getDocs(categoriesRef);
                const existingCategories = new Set();
                snapshot.forEach(doc => {
                    existingCategories.add(doc.id);
                });

                // Eliminar categor√≠as que ya no est√°n en la lista local
                const deletePromises = [];
                existingCategories.forEach(categoryId => {
                    if (!categories.includes(categoryId)) {
                        deletePromises.push(deleteDoc(doc(categoriesRef, categoryId)));
                    }
                });
                await Promise.all(deletePromises);

                // A√±adir nuevas categor√≠as
                const addPromises = categories.map(category => 
                    setDoc(doc(categoriesRef, category), { 
                        name: category,
                        createdAt: new Date().toISOString()
                    })
                );
                await Promise.all(addPromises);

                updateSyncStatus('‚úÖ Categor√≠as guardadas', '');

            } catch (error) {
                console.error('Error guardando categor√≠as:', error);
                updateSyncStatus('‚ùå Error guardando categor√≠as', 'offline');
            }
        }

        // Actualizar estado de sincronizaci√≥n
        function updateSyncStatus(text, className) {
            const syncStatus = document.getElementById('syncStatus');
            const syncText = document.getElementById('syncText');
            const spinner = syncStatus.querySelector('.spinner');
            
            syncText.textContent = text;
            syncStatus.className = `sync-status ${className}`;
            
            if (className === 'syncing') {
                spinner.style.display = 'block';
            } else {
                spinner.style.display = 'none';
            }
        }

        // Configurar event listeners
        function setupEventListeners() {
            // Rating para nuevo anime
            document.querySelectorAll('#newAnimeRating .star').forEach(star => {
                star.addEventListener('click', function() {
                    currentRating = parseInt(this.dataset.rating);
                    updateStarDisplay('#newAnimeRating', currentRating);
                });
            });

            // Rating para editar anime
            document.querySelectorAll('#editAnimeRating .star').forEach(star => {
                star.addEventListener('click', function() {
                    editRating = parseInt(this.dataset.rating);
                    updateStarDisplay('#editAnimeRating', editRating);
                });
            });

            /* Setup opening listeners dynamically */
            setupOpeningListeners();

            // Preview de imagen para nuevo anime
            document.getElementById('animeImage').addEventListener('change', function(e) {
                handleImagePreview(e, 'imagePreview', (imageData) => {
                    newAnimeImage = imageData;
                });
            });

            // Preview de imagen para editar anime
            document.getElementById('editAnimeImage').addEventListener('change', function(e) {
                handleImagePreview(e, 'editImagePreview', (imageData) => {
                    editAnimeImage = imageData;
                });
            });

            // B√∫squeda
            document.getElementById('searchInput').addEventListener('input', function(e) {
                searchTerm = e.target.value.toLowerCase();
                renderAnimes();
            });

            // Filtro de categor√≠a
            document.getElementById('categoryFilter').addEventListener('change', function(e) {
                currentCategory = e.target.value || 'all';
                renderAnimes();
            });

            // Enter key para a√±adir categor√≠a
            document.getElementById('newCategory').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addCategory();
                }
            });
        }

        /* Add function to setup opening listeners */
        function setupOpeningListeners() {
            // Openings para nuevo anime
            document.querySelectorAll('#newAnimeOpenings .opening-star').forEach(star => {
                star.addEventListener('click', function() {
                    const season = parseInt(this.dataset.season);
                    if (currentOpenings.includes(season)) {
                        currentOpenings = currentOpenings.filter(s => s !== season);
                    } else {
                        currentOpenings.push(season);
                    }
                    updateOpeningDisplay('#newAnimeOpenings', currentOpenings);
                });
            });

            // Openings para editar anime
            document.querySelectorAll('#editAnimeOpenings .opening-star').forEach(star => {
                star.addEventListener('click', function() {
                    const season = parseInt(this.dataset.season);
                    if (editOpenings.includes(season)) {
                        editOpenings = editOpenings.filter(s => s !== season);
                    } else {
                        editOpenings.push(season);
                    }
                    updateOpeningDisplay('#editAnimeOpenings', editOpenings);
                });
            });
        }

        // Manejar preview de im√°genes
        function handleImagePreview(event, previewId, callback) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById(previewId);
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                    callback(e.target.result);
                };
                reader.readAsDataURL(file);
            }
        }

        // Actualizar display de estrellas
        function updateStarDisplay(containerId, rating) {
            const stars = document.querySelectorAll(`${containerId} .star`);
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // Actualizar display de openings
        function updateOpeningDisplay(containerId, openings) {
            const stars = document.querySelectorAll(`${containerId} .opening-star`);
            stars.forEach((star) => {
                const season = parseInt(star.dataset.season);
                if (openings.includes(season)) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        /* Add function to toggle anime type in add form */
        function toggleAnimeType() {
            const type = document.getElementById('animeType').value;
            const formRow = document.getElementById('addFormRow');
            const seasonGroup = document.getElementById('seasonGroup');
            const episodeGroup = document.getElementById('episodeGroup');
            const openingsGroup = document.getElementById('openingsGroup');
            
            if (type === 'movie') {
                formRow.classList.add('movie-mode');
                seasonGroup.style.display = 'none';
                episodeGroup.style.display = 'none';
                openingsGroup.style.display = 'none';
            } else {
                formRow.classList.remove('movie-mode');
                seasonGroup.style.display = 'flex';
                episodeGroup.style.display = 'flex';
                openingsGroup.style.display = 'block';
            }
        }

        /* Add function to toggle anime type in edit modal */
        function toggleEditAnimeType() {
            const type = document.getElementById('editAnimeType').value;
            const seasonEpisodeGroup = document.getElementById('editSeasonEpisodeGroup');
            const openingsGroup = document.getElementById('editOpeningsGroup');
            
            if (type === 'movie') {
                seasonEpisodeGroup.style.display = 'none';
                openingsGroup.style.display = 'none';
            } else {
                seasonEpisodeGroup.style.display = 'grid';
                openingsGroup.style.display = 'block';
            }
        }

        /* Add function to add more season stars */
        function addSeasonStar(context) {
            const containerId = context === 'new' ? 'newAnimeOpenings' : 'editAnimeOpenings';
            const container = document.getElementById(containerId);
            const button = container.querySelector('.add-season-btn');
            
            if (context === 'new') {
                newSeasonCount++;
                const newStar = document.createElement('span');
                newStar.className = 'opening-star';
                newStar.dataset.season = newSeasonCount;
                newStar.title = `Temporada ${newSeasonCount}`;
                newStar.textContent = '‚òÖ';
                newStar.addEventListener('click', function() {
                    const season = parseInt(this.dataset.season);
                    if (currentOpenings.includes(season)) {
                        currentOpenings = currentOpenings.filter(s => s !== season);
                    } else {
                        currentOpenings.push(season);
                    }
                    updateOpeningDisplay('#newAnimeOpenings', currentOpenings);
                });
                container.insertBefore(newStar, button);
            } else {
                editSeasonCount++;
                const newStar = document.createElement('span');
                newStar.className = 'opening-star';
                newStar.dataset.season = editSeasonCount;
                newStar.title = `Temporada ${editSeasonCount}`;
                newStar.textContent = '‚òÖ';
                newStar.addEventListener('click', function() {
                    const season = parseInt(this.dataset.season);
                    if (editOpenings.includes(season)) {
                        editOpenings = editOpenings.filter(s => s !== season);
                    } else {
                        editOpenings.push(season);
                    }
                    updateOpeningDisplay('#editAnimeOpenings', editOpenings);
                });
                container.insertBefore(newStar, button);
            }
        }

        // Actualizar estad√≠sticas
        function updateStats() {
            document.getElementById('totalAnimes').textContent = animes.length;
            document.getElementById('totalCategories').textContent = categories.length;
        }

        // Toggle gestor de categor√≠as
        function toggleCategoryManager() {
            const manager = document.getElementById('categoryManager');
            manager.style.display = manager.style.display === 'none' ? 'block' : 'none';
        }

        // Toggle formulario r√°pido
        function toggleQuickAdd() {
            const quickAdd = document.getElementById('quickAdd');
            quickAdd.style.display = quickAdd.style.display === 'none' ? 'block' : 'none';
        }

        // Cambiar vista
        function switchView(view) {
            currentView = view;
            
            // Actualizar botones
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Mostrar/ocultar vistas correctamente
            if (view === 'grid') {
                document.getElementById('animeGrid').style.display = 'grid';
                document.getElementById('animeList').classList.remove('active');
            } else {
                document.getElementById('animeGrid').style.display = 'none';
                document.getElementById('animeList').classList.add('active');
            }
            
            // Re-renderizar para asegurar que se muestren los animes
            renderAnimes();
        }

        // A√±adir categor√≠a
        async function addCategory() {
            const input = document.getElementById('newCategory');
            const categoryName = input.value.trim();
            
            if (categoryName && !categories.includes(categoryName)) {
                categories.push(categoryName);
                input.value = '';
                
                // Actualizar UI inmediatamente
                updateCategorySelects();
                renderCategories();
                renderCategoryTabs();
                updateStats();
                
                try {
                    await saveCategoriesToFirebase();
                    updateSyncStatus('‚úÖ Categor√≠a a√±adida', '');
                } catch (error) {
                    console.error('Error a√±adiendo categor√≠a:', error);
                    updateSyncStatus('‚ùå Error guardando', 'offline');
                    // Revertir cambios locales si falla
                    categories = categories.filter(cat => cat !== categoryName);
                    updateCategorySelects();
                    renderCategories();
                    renderCategoryTabs();
                    updateStats();
                }
            } else if (categories.includes(categoryName)) {
                alert('Esta categor√≠a ya existe');
            }
        }

        // Eliminar categor√≠a
        async function removeCategory(categoryName) {
            if (confirm(`¬øEst√°s seguro de que quieres eliminar la categor√≠a "${categoryName}"?`)) {
                const originalCategories = [...categories];
                const originalAnimes = [...animes];
                
                // Actualizar UI inmediatamente
                categories = categories.filter(cat => cat !== categoryName);
                
                // Eliminar animes de esta categor√≠a localmente
                const animesToDelete = animes.filter(anime => anime.category === categoryName);
                animes = animes.filter(anime => anime.category !== categoryName);
                
                updateCategorySelects();
                renderCategories();
                renderCategoryTabs();
                renderAnimes();
                updateStats();
                
                try {
                    updateSyncStatus('üîÑ Eliminando...', 'syncing');
                    
                    // Eliminar animes de Firebase
                    const deletePromises = animesToDelete.map(anime => 
                        deleteDoc(doc(db, 'users', currentUser.uid, 'animes', anime.id))
                    );
                    await Promise.all(deletePromises);
                    
                    // Guardar categor√≠as actualizadas
                    await saveCategoriesToFirebase();
                    
                    updateSyncStatus('‚úÖ Categor√≠a eliminada', '');
                } catch (error) {
                    console.error('Error eliminando categor√≠a:', error);
                    updateSyncStatus('‚ùå Error eliminando', 'offline');
                    
                    // Revertir cambios si falla
                    categories = originalCategories;
                    animes = originalAnimes;
                    updateCategorySelects();
                    renderCategories();
                    renderCategoryTabs();
                    renderAnimes();
                    updateStats();
                }
            }
        }

        // Actualizar selects de categor√≠as
        function updateCategorySelects() {
            const selects = ['animeCategory', 'editAnimeCategory', 'categoryFilter'];
            
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                const currentValue = select.value;
                
                if (selectId === 'categoryFilter') {
                    select.innerHTML = '<option value="">Todas las categor√≠as</option>';
                } else {
                    select.innerHTML = '<option value="">Seleccionar...</option>';
                }
                
                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    select.appendChild(option);
                });
                
                select.value = currentValue;
            });
        }

        // Renderizar categor√≠as
        function renderCategories() {
            const container = document.getElementById('categoryList');
            container.innerHTML = '';
            
            categories.forEach(category => {
                const tag = document.createElement('div');
                tag.className = 'category-tag';
                tag.innerHTML = `
                    ${category}
                    <span class="remove" onclick="removeCategory('${category}')" title="Eliminar categor√≠a">√ó</span>
                `;
                container.appendChild(tag);
            });
        }

        // Renderizar tabs de categor√≠as
        function renderCategoryTabs() {
            const container = document.getElementById('categoryTabs');
            container.innerHTML = '';
            
            // Tab "Todas"
            const allTab = document.createElement('button');
            allTab.className = `category-tab ${currentCategory === 'all' ? 'active' : ''}`;
            allTab.textContent = `Todas (${animes.length})`;
            allTab.onclick = () => selectCategory('all');
            container.appendChild(allTab);
            
            // Tabs por categor√≠a
            categories.forEach(category => {
                const count = animes.filter(anime => anime.category === category).length;
                const tab = document.createElement('button');
                tab.className = `category-tab ${currentCategory === category ? 'active' : ''}`;
                tab.textContent = `${category} (${count})`;
                tab.onclick = () => selectCategory(category);
                container.appendChild(tab);
            });
        }

        // Seleccionar categor√≠a
        function selectCategory(category) {
            currentCategory = category;
            document.getElementById('categoryFilter').value = category === 'all' ? '' : category;
            renderCategoryTabs();
            renderAnimes();
        }

        // A√±adir anime
        async function addAnime() {
            const name = document.getElementById('animeName').value.trim();
            const category = document.getElementById('animeCategory').value;
            /* Get type and make season/episode conditional */
            const type = document.getElementById('animeType').value;
            const season = type === 'serie' ? (parseInt(document.getElementById('animeSeason').value) || 1) : null;
            const episode = type === 'serie' ? (parseInt(document.getElementById('animeEpisode').value) || 0) : null;
            
            if (!name || !category || currentRating === 0) {
                alert('Por favor, completa todos los campos obligatorios (nombre, categor√≠a y valoraci√≥n)');
                return;
            }

            const addBtn = document.getElementById('addAnimeBtn');
            addBtn.disabled = true;
            addBtn.textContent = 'A√±adiendo...';
            
            /* Add type to anime object and make openings conditional */
            const anime = {
                name: name,
                category: category,
                rating: currentRating,
                type: type,
                season: season,
                episode: episode,
                image: newAnimeImage || null,
                openings: type === 'serie' ? (currentOpenings || []) : [],
                dateAdded: new Date().toISOString()
            };
            
            try {
                updateSyncStatus('üîÑ Guardando...', 'syncing');
                
                // Generar ID √∫nico
                const animeId = Date.now().toString();
                await setDoc(doc(db, 'users', currentUser.uid, 'animes', animeId), anime);
                
                // Limpiar formulario
                document.getElementById('animeName').value = '';
                document.getElementById('animeCategory').value = '';
                document.getElementById('animeType').value = 'serie';
                document.getElementById('animeSeason').value = '1';
                document.getElementById('animeEpisode').value = '1';
                document.getElementById('animeImage').value = '';
                document.getElementById('imagePreview').style.display = 'none';
                currentRating = 0;
                currentOpenings = [];
                newAnimeImage = null;
                updateStarDisplay('#newAnimeRating', 0);
                updateOpeningDisplay('#newAnimeOpenings', []);
                toggleAnimeType(); // Reset form layout
                
                updateSyncStatus('‚úÖ Anime a√±adido', '');
                
            } catch (error) {
                console.error('Error a√±adiendo anime:', error);
                updateSyncStatus('‚ùå Error guardando', 'offline');
                alert('Error al guardar el anime. Int√©ntalo de nuevo.');
            } finally {
                addBtn.disabled = false;
                addBtn.textContent = 'A√±adir';
            }
        }

        // Filtrar animes
        function getFilteredAnimes() {
            let filtered = animes;
            
            // Filtrar por categor√≠a
            if (currentCategory !== 'all') {
                filtered = filtered.filter(anime => anime.category === currentCategory);
            }
            
            // Filtrar por b√∫squeda
            if (searchTerm) {
                filtered = filtered.filter(anime => 
                    anime.name.toLowerCase().includes(searchTerm)
                );
            }
            
            // Ordenar por rating (descendente)
            return filtered.sort((a, b) => b.rating - a.rating);
        }

        // Renderizar animes
        function renderAnimes() {
            const filteredAnimes = getFilteredAnimes();
            
            if (currentView === 'grid') {
                renderAnimeGrid(filteredAnimes);
            } else {
                renderAnimeList(filteredAnimes);
            }
        }

        // Renderizar vista de tarjetas
        function renderAnimeGrid(animes) {
            const container = document.getElementById('animeGrid');
            
            if (animes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <h3>üì∫ No se encontraron animes</h3>
                        <p>Prueba con otros filtros o a√±ade un nuevo anime</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = animes.map(anime => {
                /* Handle both movies and series */
                const type = anime.type || 'serie';
                const typeBadge = type === 'movie' 
                    ? '<span class="type-badge movie">üé¨ Pel√≠cula</span>'
                    : '<span class="type-badge serie">üì∫ Serie</span>';
                
                const progress = type === 'movie' 
                    ? ''
                    : `<div class="anime-progress">T${anime.season} - Ep. ${anime.episode}</div>`;
                
                const openingStars = type === 'serie' && anime.openings && anime.openings.length > 0 
                    ? anime.openings.sort((a, b) => a - b).map(season => `<span style="color: #ff6b9d;" title="Opening T${season}">‚òÖ</span>`).join('')
                    : type === 'serie' 
                        ? '<span style="color: #e2e8f0;">Sin openings favoritos</span>'
                        : '';
                
                const openingSection = type === 'serie' 
                    ? `<div class="anime-opening">
                        <div class="opening-label">Openings favoritos:</div>
                        <div>${openingStars}</div>
                    </div>`
                    : '';
                
                return `
                    <div class="anime-card">
                        <div class="category-tooltip">${anime.category}</div>
                        ${anime.image ? 
                            `<img src="${anime.image}" alt="${anime.name}" class="anime-image">` :
                            `<div class="anime-image">Sin imagen</div>`
                        }
                        <div class="anime-info">
                            ${typeBadge}
                            <div class="anime-title">${anime.name}</div>
                            ${progress}
                            <div class="anime-rating">
                                <span style="color: #ffd700;">${'‚òÖ'.repeat(anime.rating)}${'‚òÜ'.repeat(5 - anime.rating)}</span>
                            </div>
                            ${openingSection}
                            <div class="anime-actions">
                                <button class="btn btn-sm" onclick="editAnime('${anime.id}')">‚úèÔ∏è</button>
                                <button class="btn btn-sm btn-danger" onclick="deleteAnime('${anime.id}')">üóëÔ∏è</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Renderizar vista de lista
        function renderAnimeList(animes) {
            const container = document.getElementById('animeList');
            
            if (animes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <h3>üì∫ No se encontraron animes</h3>
                        <p>Prueba con otros filtros o a√±ade un nuevo anime</p>
                    </div>
                `;
                return;
            }
            
            /* Handle both movies and series in list view */
            container.innerHTML = animes.map(anime => {
                const type = anime.type || 'serie';
                const typeIcon = type === 'movie' ? 'üé¨' : 'üì∫';
                const progress = type === 'movie' ? 'Pel√≠cula' : `T${anime.season} - Ep. ${anime.episode}`;
                
                return `
                <div class="anime-list-item">
                    <div class="category-tooltip">${anime.category}</div>
                    ${anime.image ? 
                        `<img src="${anime.image}" alt="${anime.name}" class="anime-thumb">` :
                        `<div class="anime-thumb" style="background: #f7fafc; display: flex; align-items: center; justify-content: center; font-size: 10px; color: #a0aec0;">Sin imagen</div>`
                    }
                    <div class="anime-list-title">${typeIcon} ${anime.name}</div>
                    <div class="anime-list-progress">${progress}</div>
                    <div class="anime-list-rating">
                        <span style="color: #ffd700;">${'‚òÖ'.repeat(anime.rating)}</span>
                        <span style="color: #e2e8f0;">${'‚òÜ'.repeat(5 - anime.rating)}</span>
                    </div>
                    <div class="anime-list-actions">
                        <button class="btn btn-sm" onclick="editAnime('${anime.id}')">‚úèÔ∏è</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteAnime('${anime.id}')">üóëÔ∏è</button>
                    </div>
                </div>
            `}).join('');
        }

        // Editar anime
        function editAnime(id) {
            const anime = animes.find(a => a.id === id);
            if (!anime) return;
            
            currentEditId = id;
            editRating = anime.rating;
            editOpenings = anime.openings || [];
            editAnimeImage = anime.image;
            
            /* Set type and adjust form */
            const type = anime.type || 'serie';
            document.getElementById('editAnimeType').value = type;
            document.getElementById('editAnimeName').value = anime.name;
            document.getElementById('editAnimeCategory').value = anime.category;
            
            if (type === 'serie') {
                document.getElementById('editAnimeSeason').value = anime.season;
                document.getElementById('editAnimeEpisode').value = anime.episode;
                
                /* Ensure enough stars for existing openings */
                if (editOpenings.length > 0) {
                    const maxSeason = Math.max(...editOpenings);
                    while (editSeasonCount < maxSeason) {
                        addSeasonStar('edit');
                    }
                }
            }
            
            toggleEditAnimeType(); // Apply visibility rules
            
            updateStarDisplay('#editAnimeRating', editRating);
            updateOpeningDisplay('#editAnimeOpenings', editOpenings);
            
            if (anime.image) {
                document.getElementById('editImagePreview').src = anime.image;
                document.getElementById('editImagePreview').style.display = 'block';
            } else {
                document.getElementById('editImagePreview').style.display = 'none';
            }
            
            document.getElementById('editModal').style.display = 'block';
        }

        // Guardar edici√≥n de anime
        async function saveAnimeEdit() {
            const name = document.getElementById('editAnimeName').value.trim();
            const category = document.getElementById('editAnimeCategory').value;
            /* Get type and make season/episode conditional */
            const type = document.getElementById('editAnimeType').value;
            const season = type === 'serie' ? (parseInt(document.getElementById('editAnimeSeason').value) || 1) : null;
            const episode = type === 'serie' ? (parseInt(document.getElementById('editAnimeEpisode').value) || 0) : null;
            
            if (!name || !category || editRating === 0) {
                alert('Por favor, completa todos los campos obligatorios');
                return;
            }

            const saveBtn = document.getElementById('saveEditBtn');
            saveBtn.disabled = true;
            saveBtn.textContent = 'Guardando...';
            
            /* Add type and make openings conditional */
            const updatedAnime = {
                name: name,
                category: category,
                rating: editRating,
                type: type,
                season: season,
                episode: episode,
                image: editAnimeImage,
                openings: type === 'serie' ? (editOpenings || []) : [],
                dateAdded: animes.find(a => a.id === currentEditId)?.dateAdded || new Date().toISOString()
            };
            
            try {
                updateSyncStatus('üîÑ Guardando...', 'syncing');
                
                await setDoc(doc(db, 'users', currentUser.uid, 'animes', currentEditId), updatedAnime);
                
                updateSyncStatus('‚úÖ Cambios guardados', '');
                closeEditModal();
                
            } catch (error) {
                console.error('Error guardando cambios:', error);
                updateSyncStatus('‚ùå Error guardando', 'offline');
                alert('Error al guardar los cambios. Int√©ntalo de nuevo.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Guardar Cambios';
            }
        }

        // Eliminar anime
        async function deleteAnime(id) {
            const anime = animes.find(a => a.id === id);
            if (anime && confirm(`¬øEst√°s seguro de que quieres eliminar "${anime.name}"?`)) {
                try {
                    updateSyncStatus('üîÑ Eliminando...', 'syncing');
                    
                    await deleteDoc(doc(db, 'users', currentUser.uid, 'animes', id));
                    
                    updateSyncStatus('‚úÖ Anime eliminado', '');
                    
                } catch (error) {
                    console.error('Error eliminando anime:', error);
                    updateSyncStatus('‚ùå Error eliminando', 'offline');
                    alert('Error al eliminar el anime. Int√©ntalo de nuevo.');
                }
            }
        }

        // Cerrar modal al hacer clic fuera
        window.onclick = function(event) {
            const modal = document.getElementById('editModal');
            if (event.target === modal) {
                closeEditModal();
            }
        }
    </script>
</body>
</html>
